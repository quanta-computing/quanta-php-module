name: Quanta PHP Module builder

on:
  push:
    branches:
      - 'master'
  pull_request:
    branches:
      - '**'
    types:
      - opened
      - edited
      - synchronize
      - labeled

  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  PACKER_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  debian-builds:
    if: github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'release')
    environment: build
    name: 'Building ${{ matrix.php-version }} for Debian ${{ matrix.debian-version }}'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php-version: [php73, php74] #php72, php80, php81, php82
        debian-version: [jessie, stretch, buster] #bullseye, bookworm

    steps:
    - name: Clone Quanta PHP Module repository
      uses: actions/checkout@v3
      with:
        path: php-module

    - name: Clone Buildozer repository
      uses: actions/checkout@v3
      with:
        ssh-key: ${{ secrets.BUILDOZER_DEPLOY_KEY }}
        repository: quanta-computing/buildozer
        persist-credentials: true
        path: tools

    - name: Build the PHP package
      run: |
        cd tools
        ./buildozer -t ${{ matrix.php-version }}-quanta-mon -o debian -v ${{ matrix.debian-version }} -s ../php-module/extension/ -r ${{ matrix.debian-version }}

    - name: gzip packages
      run: |
        cd tools/debian/${{ matrix.debian-version }}/pkg/
        tar czvf debian-${{ matrix.debian-version }}-${{ matrix.php-version }}.tgz ${{ matrix.php-version }}-quanta-mon-${{ matrix.debian-version }}

    - name: Upload package to release
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: tools/debian/${{ matrix.debian-version }}/pkg/debian-${{ matrix.debian-version }}-${{ matrix.php-version }}.tgz
        asset_name: debian-${{ matrix.debian-version }}-${{ matrix.php-version }}.tgz
        tag: ${{ github.ref }}
        overwrite: true
        body: "Packages of ${{ matrix.php-version }} for Debian ${{ matrix.debian-version }} are ready"


  # centos-builds:
  #   if: github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'release')
  #   environment: build
  #   name: 'Building ${{ matrix.php-version }} for CentOS ${{ matrix.centos-version }}'
  #   runs-on: ubuntu-latest
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       php-version: [php73, php74] #php72, php80, php81, php82
  #       centos-version: [6, 7] #8

  #   steps:
  #   - name: Clone Quanta PHP Module repository
  #     uses: actions/checkout@v3
  #     with:
  #       path: php-module

  #   - name: Clone Buildozer repository
  #     uses: actions/checkout@v3
  #     with:
  #       ssh-key: ${{ secrets.BUILDOZER_DEPLOY_KEY }}
  #       repository: quanta-computing/buildozer
  #       persist-credentials: true
  #       path: tools

  #   - name: Build the PHP package
  #     run: |
  #       cd tools
  #       ./buildozer -t ${{ matrix.php-version }}-quanta-mon -o centos -v ${{ matrix.centos-version }} -s ../php-module/extension/ -r centos-${{ matrix.centos-version }}
